<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SRL Writing Phase Assistant</title>

<style>
:root{
  --bg:#0f1220;
  --panel:rgba(255,255,255,0.08);
  --text:#eaeaf0;
  --muted:#9aa0b4;
  --accent:#7dd3fc;
}
body{
  margin:0;
  font-family:system-ui;
  background:radial-gradient(circle at top,#1a1f3a,var(--bg));
  color:var(--text);
}
.container{
  max-width:1100px;
  margin:30px auto;
  padding:20px;
  display:grid;
  grid-template-columns:2fr 1fr;
  gap:20px;
}
.panel{
  background:var(--panel);
  border-radius:16px;
  padding:20px;
}
textarea{
  width:100%;
  min-height:360px;
  background:rgba(0,0,0,0.4);
  color:var(--text);
  border:none;
  border-radius:14px;
  padding:18px;
  font-size:16px;
  line-height:1.6;
}
h2{margin-top:0;font-weight:500;}
.metric{margin-bottom:14px;}
.metric span{
  display:block;
  font-size:13px;
  color:var(--muted);
}
.metric strong{
  font-size:20px;
}
#coach{
  margin-top:18px;
  padding:14px;
  border-radius:12px;
  background:rgba(125,211,252,0.15);
  color:var(--accent);
}
.footer{
  grid-column:1/-1;
  text-align:center;
  color:var(--muted);
  font-size:13px;
  margin-top:20px;
}
</style>
</head>

<body>
<div class="container">

<div class="panel">
  <h2>Writing Task</h2>
  <p style="color:var(--muted)">
    Write naturally. The system infers dominant SRL phases over time.
  </p>
  <textarea id="editor" placeholder="Start writing here..."></textarea>
  <div id="coach"></div>
</div>

<div class="panel">
  <h2>SRL Phase Support</h2>

  <div class="metric">
    <span>Dominant Phase</span>
    <strong id="phase">Planning</strong>
  </div>

  <div class="metric">
    <span>Why?</span>
    <strong id="reason">—</strong>
  </div>

  <div class="metric">
    <span>What helps now</span>
    <strong id="suggestion">—</strong>
  </div>
</div>

<div class="footer">
Pattern-based SRL phase inference · Single-file prototype
</div>

</div>

<script>
const editor = document.getElementById("editor");
const coach = document.getElementById("coach");

let startTime = null;
let lastKeyTime = null;
let lastWordCount = 0;
let deletions = 0;
let events = [];

const WINDOW = 60000; // 60s
const INACTIVITY = 120000;
let idleTimer;

editor.addEventListener("keydown", e => {
  const now = performance.now();
  if (!startTime) startTime = now;

  let type = "type";
  if (e.key === "Backspace" || e.key === "Delete") {
    type = "delete";
    deletions++;
  }

  events.push({ time: now, type });
  events = events.filter(ev => now - ev.time <= WINDOW);

  lastKeyTime = now;
  hideCoach();
  resetIdle();
  updatePhase();
});

function resetIdle(){
  clearTimeout(idleTimer);
  idleTimer = setTimeout(() => {
    coach.textContent =
      "You paused for a while. This is normal. Decide your next step and continue.";
    coach.style.display = "block";
  }, INACTIVITY);
}
function hideCoach(){ coach.style.display = "none"; }

// --- CORE PHASE ENGINE ---
function inferPhase(){
  const now = performance.now();
  const elapsed = startTime ? now - startTime : 1;
  const words = editor.value.trim().split(/\s+/).filter(Boolean).length;
  const newWords = Math.max(words - lastWordCount, 0);
  lastWordCount = words;

  const deletes = events.filter(e => e.type === "delete").length;
  const types = events.length || 1;
  const deleteRatio = deletes / types;

  const sessionProgress = words / 250; // soft expectation
  const idleGap = lastKeyTime ? now - lastKeyTime : 0;

  // ---- PHASE SCORES ----
  let scores = {
    Planning: 0,
    Performance: 0,
    Monitoring: 0,
    Reflection: 0
  };

  // Planning
  if (words < 60) scores.Planning += 2;
  if (deleteRatio > 0.3) scores.Planning += 1;
  if (sessionProgress < 0.3) scores.Planning += 1;

  // Performance
  if (newWords > 8) scores.Performance += 2;
  if (deleteRatio < 0.2) scores.Performance += 1;
  if (sessionProgress > 0.2 && sessionProgress < 0.8) scores.Performance += 1;

  // Monitoring
  if (deleteRatio > 0.25 && words > 80) scores.Monitoring += 2;
  if (newWords < 5 && deletes > 3) scores.Monitoring += 1;

  // Reflection
  if (words > 180) scores.Reflection += 1;
  if (idleGap > 4000 && sessionProgress > 0.7) scores.Reflection += 2;
  if (newWords === 0 && words > 150) scores.Reflection += 1;

  // Pick dominant phase
  let phase = Object.keys(scores)
    .reduce((a, b) => scores[a] > scores[b] ? a : b);

  const explanations = {
    Planning: {
      reason: "Early-stage writing and idea shaping",
      suggestion: "Outline ideas or write rough notes."
    },
    Performance: {
      reason: "Sustained idea execution",
      suggestion: "Keep expressing ideas without over-editing."
    },
    Monitoring: {
      reason: "Active reviewing and revising",
      suggestion: "Check clarity and structure."
    },
    Reflection: {
      reason: "Writing slowed after substantial progress",
      suggestion: "Evaluate strengths and improvements."
    }
  };

  return { phase, ...explanations[phase] };
}

function updatePhase(){
  const result = inferPhase();
  document.getElementById("phase").textContent = result.phase;
  document.getElementById("reason").textContent = result.reason;
  document.getElementById("suggestion").textContent = result.suggestion;
}
</script>
</body>
</html>
